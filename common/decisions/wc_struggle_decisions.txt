#############################################
# Hostility Ending					    	#
# by Joe Parkin								#
#############################################
# Warcraft
#struggle_iberia_ending_hostility_decision
struggle_lordaeron_ending_hostility_decision = {
	major = yes
	title = struggle_lordaeron_ending_hostility_decision
	picture = "gfx/interface/illustrations/decisions/fp2_decision_struggle_hostility.dds"
	extra_picture = "gfx/interface/illustrations/struggle_decisions_buttons/fp2_decision_hostility.dds"
	desc = struggle_lordaeron_ending_hostility_decision_desc
	selection_tooltip = struggle_lordaeron_ending_hostility_decision_tooltip
	confirm_click_sound = "event:/DLC/FP2/SFX/UI/fp2_struggle_ending_decision_confirm"
	is_invisible = yes
	sort_order = 80

	#TODO figure out if needed
	is_shown = {
		has_fp2_dlc_trigger = yes
	}

	is_valid = {
		is_independent_ruler = yes

		OR = {
			custom_tooltip = {
				text = struggle_lordaeron_ending_hostility_decision_correct_phase_tt
				any_character_struggle = {
					involvement = involved
					is_struggle_type = lordaeron_struggle
					is_struggle_phase = struggle_lordaeron_phase_hostility
				}
			}
			## Completely control Hispania for 5 years
			AND = {
				completely_controls_region = world_lordaeron_struggle
				primary_title =  {
					tier >= tier_kingdom
					title_held_years >= 5
				}
			}
		}

		custom_tooltip = {
			text = struggle_ending_decision_correct_involvement_tt
			any_character_struggle = {
				involvement = involved
				is_struggle_type = lordaeron_struggle
			}
		}

		# Hold and completely control two de jure kingdoms of Hispania
		OR = {
			custom_tooltip = { #
				text = struggle_lordaeron_ending_hostility_decision_kingdom_tt
				any_held_title = { # 1st kingdom
					tier = tier_kingdom
					de_jure_liege = title:e_lordaeron
					root = { completely_controls = prev }
					save_temporary_scope_as = lordaeron_kingdom
				}
				any_held_title = { # 2nd kingdom
					tier = tier_kingdom
					de_jure_liege = title:e_lordaeron
					trigger_if = {
						limit = { exists = scope:lordaeron_kingdom }
						NOT = { this = scope:lordaeron_kingdom }
					}
					root = { completely_controls = prev }
					save_temporary_scope_as = lordaeron_kingdom_2
				}
			}
			custom_tooltip = {
				text = struggle_lordaeron_ending_hostility_decision_united_lordaeron_throne_tt
				AND = {
					exists = global_var:unite_the_lordaeron_thrones_decision_title
					primary_title = global_var:unite_the_lordaeron_thrones_decision_title
				}
			}
		}


		# All your capital kingdom's de jure counties are of your culture and faith
		trigger_if = {
			limit = {
				exists = global_var:unite_the_lordaeron_thrones_decision_title
				primary_title = global_var:unite_the_lordaeron_thrones_decision_title
			}
			custom_tooltip = {
				text = struggle_lordaeron_ending_hostility_decision_county_light_tt
				capital_county.de_jure_liege.de_jure_liege = {
					any_de_jure_county = {
						percent >= 0.75
						culture = root.culture
						faith = root.faith
					}
				}
			}
		}
		trigger_else = {
			custom_tooltip = {
				text = struggle_lordaeron_ending_hostility_decision_county_tt
				capital_county.de_jure_liege.de_jure_liege = {
					any_de_jure_county = {
						count = all
						culture = root.culture
						faith = root.faith
					}
				}
			}
		}

		# No other realm controls more than 20% of the Lordaeron region
		custom_tooltip = {
			text = struggle_lordaeron_ending_hostility_decision_region_tt
			NOT = {
				struggle:lordaeron_struggle = {
					any_involved_ruler = {
						NOT = { this = root }
						is_independent_ruler = yes
						exists = primary_title
						primary_title = { is_mercenary_company = no }
						save_temporary_scope_as = lordaeron_realm
						any_county_in_region = {
							region = world_lordaeron_struggle
							percent > wc_struggle_hostility_region_percent_decimal_value
							holder.top_liege = scope:lordaeron_realm
						}
					}
				}
			}
		}

		# Completely control at least 2 of the important Lordaeron duchies
		calc_true_if = {
			amount >= 2
			completely_controls = title:d_lordaeron
			completely_controls = title:d_brill
			completely_controls = title:d_stratholme
			completely_controls = title:d_hearthglen
			completely_controls = title:d_tyrs_hand
		}
	}

	effect = {
		##### Major Effects #####
		show_as_tooltip = {
			dynasty = { add_dynasty_prestige = 10000 }
			wc_struggle_hostility_ender_effect = yes
		}
		# Hispania is available!
		custom_tooltip = wc_struggle_can_create_empire_of_lordaeron_tt
		custom_description_no_bullet = { text = wc_struggle_house_tt }
		# Keep the Struggle Clash for your House
		custom_tooltip = fp2_struggle_can_keep_using_struggle_clash_tt
		# Boost to culture and faith conversion
		custom_tooltip = fp2_struggle_hostility_conversion_tt
		# Damage opinion with other culture/faiths
		custom_tooltip = fp2_struggle_hostility_opinion_tt
		custom_tooltip = fp2_struggle_hostility_opinion_negative_tt
		# Choose Holy War boost, Culture War boost, or both
		custom_description_no_bullet = { text = fp2_struggle_hostility_list_tt }
		#custom_tooltip = fp2_struggle_hostility_holy_cb_joint_tt
		#custom_tooltip = wc_struggle_hostility_culture_cb_tt



		show_as_tooltip = {
			stress_impact = {
				humble = medium_stress_impact_gain
				cynical = medium_stress_impact_gain
			}
		}


		# Achievements
		#add_achievement_global_variable_effect = {
		#	VARIABLE = fp2_iberian_hostilities_achievement_unlocked
		#	VALUE = yes
		#}
		#fp2_holiday_in_iberia_check = yes

		# Trigger a player facing event as a coda
		trigger_event = lordaeron_struggle.0900
	}

	cost = {}

	ai_check_interval = 120

	ai_potential = { always = yes }

	ai_will_do = { base = 100 }
}

#############################################
# Compromise Ending					    	#
# by Joe Parkin								#
#############################################
# Warcraft
#struggle_lordaeron_ending_compromise_decision = {}
struggle_lordaeron_ending_compromise_decision = {
	major = yes
	title = struggle_lordaeron_ending_compromise_decision
	picture = "gfx/interface/illustrations/decisions/fp2_decision_struggle_compromise.dds"
	extra_picture = "gfx/interface/illustrations/struggle_decisions_buttons/fp2_decision_compromise.dds"
	desc = struggle_lordaeron_ending_compromise_decision_desc
	selection_tooltip = struggle_lordaeron_ending_compromise_decision_tooltip
	confirm_click_sound = "event:/DLC/FP2/SFX/UI/fp2_struggle_ending_decision_confirm"
	is_invisible = yes

	sort_order = 80

	#TODO figure out if needed
	is_shown = {
		has_fp2_dlc_trigger = yes
	}

	is_valid = {
		is_independent_ruler = yes

		custom_tooltip = {
			text = struggle_lordaeron_ending_compromise_decision_correct_phase_tt
			any_character_struggle = {
				is_struggle_type = lordaeron_struggle
				is_struggle_phase = struggle_lordaeron_phase_compromise
			}
		}

		custom_tooltip = {
			text = struggle_ending_decision_correct_involvement_tt
			any_character_struggle = {
				involvement = involved
				is_struggle_type = lordaeron_struggle
			}
		}

		OR = {
			# Exalted among Men or higher
			prestige_level >= very_high_prestige_level
			# Hold and completely control a de jure kingdom of Hispania
			custom_tooltip = {
				text = struggle_lordaeron_ending_compromise_decision_kingdom_tt
				wc_struggle_ending_hold_de_jure_kingdom_trigger = yes
			}
		}

		# Control less than 50% of Iberia
		custom_tooltip = {
			text = struggle_lordaeron_ending_compromise_decision_region_tt
			wc_struggle_ending_percent_lordaeron_trigger = yes
		}

		# No one else controls more than 50% of Iberia
		custom_tooltip = {
			text = struggle_lordaeron_ending_compromise_decision_other_region_tt
			wc_struggle_ending_other_percent_lordaeron_trigger = yes
		}

		# No Independent Involved rulers are at war with each other
		custom_tooltip = {
			text = struggle_lordaeron_ending_compromise_truce_tt
			NOT = {
				struggle:lordaeron_struggle = {
					any_involved_ruler = {
						is_independent_ruler = yes
						primary_title = { is_mercenary_company = no }
						any_primary_war_enemy = {
							is_independent_ruler = yes
							any_character_struggle = {
								involvement = involved
								is_struggle_type = lordaeron_struggle
							}
							primary_title = { is_mercenary_company = no }
						}
					}
				}
			}
		}

		OR = {
			# Every other involved independent ruler in Iberia has at least 60 opinion of you or is strong hooked
			custom_tooltip = {
				text = struggle_lordaeron_ending_compromise_decision_opinion_tt
				struggle:lordaeron_struggle = {
					NOT = {
						any_involved_ruler = {
							NOT = { this = root }
							is_independent_ruler = yes
							primary_title = { is_holy_order = no }
							primary_title = { is_mercenary_company = no }
							save_temporary_scope_as = this_character
							NOR = {
								root = { has_strong_hook = scope:this_character }
								opinion = {
									target = root
									value >= struggle_lordaeron_ending_compromise_decision_opinion_value
								}
							}
						}
					}
				}
			}
			# No other independent ruler in Iberia is a king or above
			custom_tooltip = {
				text = struggle_lordaeron_ending_compromise_decision_independent_tt
				struggle:lordaeron_struggle = {
					NOT = {
						any_involved_ruler = {
							NOT = { this = root }
							is_independent_ruler = yes
							primary_title = { is_mercenary_company = no }
							primary_title.tier >= tier_kingdom
						}
					}
				}
			}
			# More than 25% of Iberia is controlled by Interloper or Uninvolved rulers
			custom_tooltip = {
				text = struggle_lordaeron_ending_compromise_decision_interloper_tt
				any_county_in_region = {
					region = world_lordaeron_struggle
					percent > wc_struggle_compromise_uninvolved_percent_decimal_value
					holder.top_liege = { wc_character_interloper_in_struggle_trigger = yes }
				}
			}
		}

		# Completely control any of the important Iberian duchies
		calc_true_if = {
			amount >= 1
			completely_controls = title:d_lordaeron
			completely_controls = title:d_brill
			completely_controls = title:d_stratholme
			completely_controls = title:d_hearthglen
			completely_controls = title:d_tyrs_hand
		}
	}

	effect = {
		##### Major Effects #####
		# Personal effects for ruler
		show_as_tooltip = { wc_struggle_compromise_ender_effect = yes }
		# Independent/Split De Jure Duchies will become De Jure Kingdoms
		if = {
			limit = {
				title:e_lordaeron = {
					any_in_de_jure_hierarchy = { wc_struggle_ending_compromise_independent_duchy_trigger = yes }
				}
			}
			custom_tooltip = wc_struggle_compromise_create_new_kingdoms_tt
		}
		# Other Tooltips!
		wc_struggle_compromise_tooltip_effect = yes

		##### Minor Effects #####
		# Self-sufficiency/defensive modifiers for each independent realm
		show_as_tooltip = { wc_struggle_compromise_modifier_rewards_effect = yes }

		show_as_tooltip = {
			stress_impact = {
				arrogant = medium_stress_impact_gain
			}
		}

		# Achievements
		#add_achievement_global_variable_effect = {
		#	VARIABLE = fp2_iberian_compromise_achievement_unlocked
		#	VALUE = yes
		#}
		#fp2_holiday_in_iberia_check = yes

		# Trigger a player facing event as a coda
		trigger_event = lordaeron_struggle.0901
	}

	cost = {}

	ai_check_interval = 120

	ai_potential = { always = yes }

	ai_will_do = { base = 100 }
}

#############################################
# Conciliation Ending					    #
# by Joe Parkin								#
#############################################
# Warcraft
#struggle_iberia_ending_conciliation_decision = {}
struggle_lordaeron_ending_conciliation_decision = {
	major = yes
	title = struggle_lordaeron_ending_conciliation_decision
	picture = "gfx/interface/illustrations/decisions/fp2_decision_struggle_conciliation.dds"
	extra_picture = "gfx/interface/illustrations/struggle_decisions_buttons/fp2_decision_conciliation.dds"
	desc = struggle_lordaeron_ending_conciliation_decision_desc
	selection_tooltip = struggle_lordaeron_ending_conciliation_decision_tooltip
	confirm_click_sound = "event:/DLC/FP2/SFX/UI/fp2_struggle_ending_decision_confirm"
	is_invisible = yes

	sort_order = 80

	# TODO find out if this is needed
	is_shown = {
		has_fp2_dlc_trigger = yes
	}

	is_valid = {
		is_independent_ruler = yes

		custom_tooltip = {
			text = struggle_lordaeron_ending_conciliation_decision_correct_phase_tt
			any_character_struggle = {
				is_struggle_type = lordaeron_struggle
				is_struggle_phase = struggle_lordaeron_phase_conciliation
			}
		}

		custom_tooltip = {
			text = struggle_ending_decision_correct_involvement_tt
			any_character_struggle = {
				involvement = involved
				is_struggle_type = lordaeron_struggle
			}
		}

		prestige_level >= very_high_prestige_level # Exalted among Men or higher

		# Hold and completely control a de jure kingdom of Hispania
		custom_tooltip = {
			text = struggle_lordaeron_ending_compromise_decision_kingdom_tt
			wc_struggle_ending_hold_de_jure_kingdom_trigger = yes
		}

		# Every other independent involved ruler in Iberia is allied to you
		custom_tooltip = {
			text = struggle_lordaeron_ending_conciliation_decision_alliance_tt
			struggle:lordaeron_struggle = {
				NOT = {
					any_involved_ruler = {
						is_independent_ruler = yes
						primary_title = { is_mercenary_company = no }
						primary_title = { is_holy_order = no }
						NOR = {
							this = root
							is_allied_to = root
						}
					}
				}
			}
		}

		# Control less than 50% of Iberia
		custom_tooltip = {
			text = struggle_lordaeron_ending_compromise_decision_region_tt
			wc_struggle_ending_percent_lordaeron_trigger = yes
		}
	}

	effect = {
		##### Major Effects #####
		show_as_tooltip = {
			wc_struggle_conciliation_ender_effect = yes
			wc_struggle_conciliation_tooltip_effect = yes
			wc_struggle_conciliation_modifier_rewards_effect = yes
		}

		show_as_tooltip = {
			stress_impact = {
				arrogant = medium_stress_impact_gain
				zealous = medium_stress_impact_gain
			}
		}

		# Achievements
		#add_achievement_global_variable_effect = {
		#	VARIABLE = fp2_iberian_conciliation_achievement_unlocked
		#	VALUE = yes
		#}
		#fp2_holiday_in_iberia_check = yes


		# Trigger a player facing event as a coda
		trigger_event = lordaeron_struggle.0902
	}

	cost = {}

	ai_check_interval = 120

	ai_potential = { always = yes }

	ai_will_do = { base = 100 }
}

unite_the_lordaeron_thrones_decision = {
	picture = "gfx/interface/illustrations/decisions/decision_realm.dds"
	major = yes
	ai_check_interval = 60
	desc = unite_the_lordaeron_thrones_decision_desc

	is_shown = {
		culture = { has_cultural_pillar = heritage_arathi }
		game_start_date >= 604.6.6
		OR = {
			calc_true_if = { #At least 2 of the titles has de jure land
				amount >= 2
				title:k_lordaeron = { any_in_de_jure_hierarchy = { tier = tier_county } }
				title:k_stratholme = { any_in_de_jure_hierarchy = { tier = tier_county } }
			}
		}
		NOT = {
			is_target_in_global_variable_list = {
				name = unavailable_unique_decisions
				target = flag:unite_the_lordaeron_thrones_decision
			}
		}
		highest_held_title_tier < tier_empire
	}

	is_valid = {
		culture = { has_cultural_pillar = heritage_arathi }
		trigger_if = {
			limit = { title:k_lordaeron = { any_in_de_jure_hierarchy = { tier = tier_county } } } #Has de jure land
			completely_controls = title:k_lordaeron
			has_title = title:k_lordaeron
		}
		trigger_if = {
			limit = { title:k_stratholme = { any_in_de_jure_hierarchy = { tier = tier_county } } } #Has de jure land
			completely_controls = title:k_stratholme
			has_title = title:k_stratholme
		}
		custom_description = {
   			text = unite_the_lordaeron_thrones_decision_primary
			OR = {
				has_primary_title = title:k_lordaeron
				has_primary_title = title:k_stratholme
			}
		}
		#Must not be too early
		culture = { has_cultural_era_or_later = culture_era_high_medieval }
		OR = {
			has_realm_law = crown_authority_2
			has_realm_law = crown_authority_3
		}
	}

	effect = {
		save_scope_as = lordaeron_uniter

		show_as_tooltip = { unite_the_lordaeron_thrones_decision_effects = yes } #Actually applied in iberia_north_africa.0005 - prestige, laws, title changes

		#Events
		trigger_event = iberia_north_africa.0005
		every_player = {
			limit = {
				NOT = { this = scope:lordaeron_uniter }
				is_within_diplo_range = { CHARACTER = scope:lordaeron_uniter }
			}
			trigger_event = iberia_north_africa.0006
		}

		#Can only be done once
		add_to_global_variable_list = {
			name = unavailable_unique_decisions
			target = flag:unite_the_lordaeron_thrones_decision
		}
		set_global_variable = {
			name = unite_the_lordaeron_thrones_decision
			value = scope:lordaeron_uniter
		}
		set_global_variable = {
			name = unite_the_lordaeron_thrones_decision_title
			value = scope:lordaeron_uniter.primary_title
		}
	}

	ai_potential = {
		always = yes
	}

	ai_will_do = {
		base = 100
	}
}