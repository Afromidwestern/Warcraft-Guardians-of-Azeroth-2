#Earth Mother Faith Blessing/Punishment Event Chain
on_character_faith_change = {
	on_actions = {
		wc_earth_faith_on_character_faith_change
		quilboar_faith_change_blood_shards
	}
}
wc_earth_faith_on_character_faith_change = {
	first_valid = {
		cen_kal.1045
		cen_kal.1048
	}
}

on_game_start_after_lobby = { on_actions = { quilboar_add_blood_shards_trait_all_chars } }

on_birth_child = { on_actions = { quilboar_add_blood_shards_trait } }

#Central Kalimdor Random Event Triggers
yearly_playable_pulse = {
	on_actions = {
		wc_cen_kal_yearly_playable_pulse
		goblin_depot_operation_events
	}
}

on_death = {
	on_actions = {
		quilboar_pass_flag_blood_shards
		quilboar_pass_modifier_blood_shards
	}
}

quarterly_playable_pulse = {
	on_actions = {
		goblin_depot_flag_updates
	}
}

wc_cen_kal_yearly_playable_pulse = {
	on_actions = {
		delay = { days = { 1 90 } }
		central_kal_events.1 #Central Kalimdor Random Events
		delay = { months = { 4 8 } }
		earth_mother_events.1 #Earth Mother Specific Events
	}
	events = {
		cen_kal.1051 #Yearly cost of quilboar blood stones search
		cen_kal.1059 #Yearly cost of quilboar blood stones ritual
	}
}

central_kal_events.1 = {
	random_events = {
        chance_to_happen = 75
        chance_of_no_event = { value = 25 }
		25 = cen_kal.1000
		5 = cen_kal.1001
		5 = cen_kal.1010
		5 = cen_kal.1025
		5 = cen_kal.1053
	}
}
earth_mother_events.1 = {
	random_events = {
        chance_to_happen = 100
        chance_of_no_event = { value = 75 }
		25 = cen_kal.1040
		25 = cen_kal.1031
	}
}

goblin_depot_under_constr_events = {
	random_events = {
        chance_to_happen = 100
        chance_of_no_event = { value = 0 } 
		25 = cen_kal.1002 #Mine success
		40 = cen_kal.1003 #Run with money
		20 = cen_kal.1004 #Explosion camp
		85 = cen_kal.1005 #Goblin coup
		170 = cen_kal.1008 #Nothing happens
	}
}

goblin_depot_operation_events = {
	trigger = { has_character_flag = has_working_depot }
	random_events = {
        chance_to_happen = 100
        chance_of_no_event = { value = 0 }
		500 = cen_kal.1007 #Mine returns
		20 = cen_kal.1004 #Explosion camp
		100 = cen_kal.1005 #Goblin coup
	}
}

quilboar_pass_flag_blood_shards = {
	effect = {
		if = {
			limit = { has_character_flag = has_working_bloodstone_foragers }
			player_heir ?= { add_character_flag = has_working_bloodstone_foragers }
		}
	}
}

quilboar_pass_modifier_blood_shards = {
	effect = {
		if = {
			limit = { has_character_modifier = wc_quilboar_bloodshards }
			player_heir ?= { 
				set_variable = {
					name = blood_shard_count
					value = root.var:blood_shard_count
				}
				add_character_modifier = wc_quilboar_bloodshards
			}
		}
	}
}

quilboar_faith_change_blood_shards = {
	effect = {
		if = { limit = { has_character_modifier = wc_quilboar_aga_str } remove_character_modifier = wc_quilboar_aga_str }
		if = { limit = { has_character_modifier = wc_quilboar_aga_agl } remove_character_modifier = wc_quilboar_aga_agl }
		if = { limit = { has_character_modifier = wc_quilboar_aga_wis } remove_character_modifier = wc_quilboar_aga_wis }
		if = { limit = { has_character_modifier = wc_quilboar_aga_spr } remove_character_modifier = wc_quilboar_aga_spr }
		if = { limit = { has_character_modifier = wc_quilboar_aga_rzh } remove_character_modifier = wc_quilboar_aga_rzh }
		remove_character_flag = has_working_bloodstone_foragers
		remove_character_flag = has_active_quilboar_ritual
		remove_character_modifier = wc_quilboar_bloodshards
		if = {
			limit = { faith = faith:agamaggan_worship }
			if = { limit = { NOT = { exists = var:blood_shard_count } } set_variable = { name = blood_shard_count value = 0 } }
			if = { limit = { is_ai = no } add_character_modifier = wc_quilboar_bloodshards }
		}
	}
}

quilboar_add_blood_shards_trait = {
	effect = {
		if = {
			limit = { faith = faith:agamaggan_worship }
			if = { limit = { NOT = { exists = var:blood_shard_count } } set_variable = { name = blood_shard_count value = 0 } }
			if = { limit = { is_ai = no } add_character_modifier = wc_quilboar_bloodshards }
		}
	}
}

quilboar_add_blood_shards_trait_all_chars = {
	effect = {
		faith:agamaggan_worship = {
			every_faith_ruler = {
				set_variable = {
					name = blood_shard_count
					value = 0
				}
				if = { limit = { is_ai = no } add_character_modifier = wc_quilboar_bloodshards }
			}
		}
	}
}

goblin_depot_flag_updates = {
	effect = {
		#Doesn't have flag, but has control over a depot
		if = {
			limit = { NOT = { has_character_flag = has_working_depot } }
			every_sub_realm_county = {
				limit = {
					holder = root
					title_province = {
						OR = {
							has_province_modifier = wc_moderated_depot
							has_province_modifier = wc_disabled_depot
							has_province_modifier = wc_overclocked_depot
							has_province_modifier = wc_normal_depot
						}
					}
				}
				save_scope_as = depot_location
			}
			if = {
				limit = { exists = scope:depot_location }
				add_character_flag = has_working_depot	
				set_variable = {
					name = depot_location
					value = scope:depot_location.title_province
				}
				set_variable = {
					name = depot_work_state 
					value = 1
				}
				if = {
					limit = { faith = { has_doctrine = tenet_sanctity_of_nature } }
					set_variable = {
						name = depot_work_state 
						value = 0
					}
				}
			}
		}
		#Has flag, depot location not under their control
		if = {
			limit = {
				has_character_flag = has_working_depot
				OR = {
					NOT = { exists = var:depot_location }
					NOT = { var:depot_location.province_owner = root }
				}
			}
			every_sub_realm_county = {
				limit = {
					holder = root
					title_province = {
						OR = {
							has_province_modifier = wc_moderated_depot
							has_province_modifier = wc_disabled_depot
							has_province_modifier = wc_overclocked_depot
							has_province_modifier = wc_normal_depot
						}
					}
				}
				save_scope_as = depot_location
			}
			if = {
				limit = { exists = scope:depot_location } 
				set_variable = {
					name = depot_location
					value = scope:depot_location
				}
			}
			if = {
				limit = { NOT = { exists = scope:depot_location } }
				remove_character_flag = has_working_depot
				if = { limit = { exists = var:depot_location } remove_variable = depot_location }
				if = { limit = { exists = var:goblin_prospector } remove_variable = depot_location }
			}
		}
		#Has flag but goblin leader is dead
		if = {
			limit = {
				exists = var:depot_location
				has_character_flag = has_working_depot
				OR = {
					NOT = { exists = var:goblin_prospector }
					var:goblin_prospector = { is_alive = no }
				}
			}
			create_character = {
				location = root.capital_province
				trigger_race_giving_no_gene_effect = yes   
				trait=creature_goblin
				culture=culture:blackwater
				faith=faith:cult_of_wealth
				dynasty=none
				stewardship = { 14 22 }
				age = { 25 35 }
				gender_female_chance = 50
				save_scope_as = goblin_prospector
			}
			set_variable = {
				name = goblin_prospector
				value = scope:goblin_prospector
			}
		}
	}
}
