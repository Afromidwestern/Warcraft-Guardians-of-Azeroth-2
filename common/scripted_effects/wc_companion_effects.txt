########
# Animal Companion
########

#Effect to start the story and show the right modifier
start_animal_story_cycle_effect = {
	hidden_effect = {
		create_story = story_cycle_animal_companion
	}
}

#Pick out name options to show
assign_name_options_companion_story_cycle_effect = {
	if = {
		limit = { has_character_modifier = wolf_companion }

		random_list = {
			1 = {
				trigger = { NOT = { has_character_flag = name_amiable } }
				add_character_flag = name_amiable
			}
			1 = {
				trigger = { NOT = { has_character_flag = name_nosewise } }
				add_character_flag = name_nosewise
			}
			1 = {
				trigger = { NOT = { has_character_flag = name_holdfast } }
				add_character_flag = name_holdfast
			}
			10 = {
				trigger = {
					NOT = { has_character_flag = name_gray }
					scope:story.var:companion_fur_color = flag:gray
				}
				add_character_flag = name_gray
			}
			10 = {
				trigger = {
					NOT = { has_character_flag = name_choplicker }
					scope:story.var:companion_fur_color = flag:black
				}
				add_character_flag = name_choplicker
			}
			10 = {
				trigger = {
					NOT = { has_character_flag = name_shadow }
					scope:story.var:companion_fur_color = flag:black
				}
				add_character_flag = name_shadow
			}
			10 = {
				trigger = {
					NOT = { has_character_flag = name_snow }
					scope:story.var:companion_fur_color = flag:white
				}
				add_character_flag = name_snow
			}
		}
	} 
	else_if = {
		limit = { has_character_modifier = bear_companion }

		random_list = {
			1 = {
				trigger = { NOT = { has_character_flag = name_deathclaw } }
				add_character_flag = name_deathclaw
			}
			1 = {
				trigger = { NOT = { has_character_flag = name_warfrost } }
				add_character_flag = name_warfrost
			}
			1 = {
				trigger = { NOT = { has_character_flag = name_gnawbone } }
				add_character_flag = name_gnawbone
			}
			1 = {
				trigger = { NOT = { has_character_flag = name_blackjack } }
				add_character_flag = name_blackjack
			}
			1 = {
				trigger = { NOT = { has_character_flag = name_largepaw } }
				add_character_flag = name_largepaw
			}
		}
	} 
	else = {
		if = {
			limit = {
				NOT = {
					has_character_flag = name_default
				}
			}
			add_character_flag = name_default
		}
	}
}

#Assign the gender of the companion
assign_companion_gender_effect = {
	save_temporary_scope_value_as = {
		name = gender
		value = flag:$GENDER$
	}
	if = {
		limit = { scope:gender = flag:random }
		hidden_effect = {
			random_list = {
				50 = {
					set_variable = {
						name = companion_gender
						value = flag:female
					}
				}
				50 = {
					set_variable = {
						name = companion_gender
						value = flag:male
					}
				}
			}
		}
	}
	else_if = {
		limit = {
			OR = {
				scope:gender = flag:male
				scope:gender = flag:female
			}
		}
		set_variable = {
			name = companion_gender
			value = flag:$GENDER$
		}
	}
}

#Remove everything related to the story
remove_companion_story_modifiers_effect = {
	if = {
		limit = {
			has_character_modifier = raven_companion
		}
		remove_character_modifier = raven_companion
	}
	else_if = {
		limit = {
			has_character_modifier = bear_companion
		}
		remove_character_modifier = bear_companion
	}
}

remove_companion_name_effect = {
	remove_variable = story_cycle_animal_companion_name
	remove_localized_text = story_cycle_animal_companion_name
}

#Effect to transfer the story to another character
transfer_companion_story_cycle_to_effect = {
	remove_companion_story_modifiers_effect = yes

	save_temporary_scope_as = original_owner

	$CHARACTER$ = {
		set_variable = {
			name = story_cycle_animal_companion_name
			value = $STORY$.var:story_cycle_animal_companion_name
		}
		copy_localized_text = {
			key = story_cycle_animal_companion_name
			target = scope:original_owner
		}
		if = {
			limit = {
				scope:original_owner = {
					has_character_modifier = raven_companion
				}
			}
			add_character_modifier = raven_companion
		}
		else_if = {
			limit = {
				scope:original_owner = {
					has_character_modifier = bear_companion
				}
			}
			add_character_modifier = bear_companion
		}

		add_character_flag = had_companion_story
	}

	remove_companion_name_effect = yes

	$STORY$ = {
		make_story_owner = $CHARACTER$
	}
}