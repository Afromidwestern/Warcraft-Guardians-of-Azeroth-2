# Determine whether Blackhand exists or not
set_horde_characters_effect = {
	title:c_dark_portal.title_province = {
		save_scope_as = horde_entry_point
	}
	# If started in 583, give Blackhand resources and set major players
	story_owner = {
		save_scope_as = blackhand
	}
	character:10015 = {
		save_scope_as = guldan
	}
	character:10017 = {
		save_scope_as = teron
	}
	character:10019 = {
		save_scope_as = durotan
	}
	character:10050 = {
		save_scope_as = orgrim
	}
	character:52000 = {
		save_scope_as = chogall
	}
	scope:blackhand = {
		add_gold = 250
		add_dread = high_dread
		add_prestige = 750
		dynasty = {
			add_dynasty_prestige_level = 3
			add_dynasty_prestige = 3000
			add_dynasty_perk = warfare_legacy_1
			add_dynasty_perk = warfare_legacy_2
		}
		# Don't spawn armies here, it doesn't work
	}
}

# Give Horde troops
spawn_horde_troops_effect = {
	if = {
		limit = { exists = capital_province }
		spawn_army = {
			uses_supply = no
			inheritable = no
			name = horde_event_troops
			levies = {
				value = 1000
			}
			men_at_arms = {
				type = savage
				stacks = 1
			}
			men_at_arms = {
				type = blackrock_legionnaire
				stacks = 1
			}
			men_at_arms = {
				type = wolfrider
				stacks = 2
			}
			men_at_arms = {
				type = trebuchet
				stacks = 10
			}
			location = capital_province
		}
	}
}
spawn_orc_savage_troops_effect = {
	if = {
		limit = { exists = capital_province }
		spawn_army = {
			uses_supply = no
			inheritable = no
			name = horde_event_troops
			levies = {
				value = 1000
			}
			men_at_arms = {
				type = savage
				stacks = 3
			}
			men_at_arms = {
				type = wolfrider
				stacks = 2
			}
			men_at_arms = {
				type = trebuchet
				stacks = 10
			}
			location = capital_province
		}
	}
}
spawn_orc_blademaster_troops_effect = {
	if = {
		limit = { exists = capital_province }
		spawn_army = {
			uses_supply = no
			inheritable = no
			name = horde_event_troops
			levies = {
				value = 1000
			}
			men_at_arms = {
				type = blademaster
				stacks = 3
			}
			men_at_arms = {
				type = wolfrider
				stacks = 2
			}
			men_at_arms = {
				type = trebuchet
				stacks = 10
			}
			location = capital_province
		}
	}
}
spawn_orc_troops_based_on_culture_effect = {
	if = {
		limit = { culture = { has_innovation = innovation_savage } }
		spawn_orc_savage_troops_effect = yes
	}
	else_if = {
		limit = { culture = { has_innovation = innovation_blademaster } }
		spawn_orc_blademaster_troops_effect = yes
	}
	else = {
		spawn_horde_troops_effect = yes
	}
}

# Declare war on Stormwind
declare_war_on_stormwind_effect = {
	debug_log = "The Horde has declared war on Stormwind!"
	debug_log_date = yes
	
	title:k_stormwind.holder = { save_scope_as = stormwind_holder }
	
	scope:blackhand = {
		add_character_flag = {
			flag = free_mongol_cb
			days = 14
		}
		start_war = {
			cb = mongol_invasion_war
			target = title:k_stormwind.holder
			target_title = title:k_stormwind
		}
		
		trigger_event = WCHOI.6
	}
	
	every_player = {
		limit = { get_news_from_region_trigger = { REGION = world_eastern_kingdoms } }
		trigger_event = WCHOI.2 # Notification
	}
}

try_to_set_horde_story_owner = {
	if = {
		limit = { $OWNER$ = { culture_group = culture_group:orc_group } }
		$OWNER$ = {
			add_character_modifier = { modifier = great_invader_modifier }
			trigger_event = { id = WCHOI.7 days = 1 } #Spawns Horde troops
		}
		make_story_owner = $OWNER$
	}
	else = {
		end_story = yes
	}
}

invite_burning_blade_effect = {
	save_temporary_scope_as = warchief
	title:c_dark_portal.title_province = { save_temporary_scope_as = dark_portal }
	
	#Dharl
	create_character = {
		template = dharl_character_template
		name = "Dharl"
		location = scope:dark_portal
		save_scope_as = dharl
	}
	scope:dharl = {
		# Gives some land
		get_random_county_effect = { GIVER = scope:warchief }
		
		# Creates clan title
		create_title_and_vassal_change = {
			type = created
			save_scope_as = title_creation
			add_claim_on_loss = no
		}
		title:d_burning_blade = {
			change_title_holder = {
				holder = scope:dharl
				change = scope:title_creation
			}
		}
		resolve_title_and_vassal_change = scope:title_creation
		
		# Gives some gold and troops
		horde_clan_start_pack_effect = yes
		clan_setup_effect = { clan = title:d_burning_blade }
	}
}
invite_dragonmaw_effect = {
	save_temporary_scope_as = warchief
	title:c_dark_portal.title_province = { save_temporary_scope_as = dark_portal }
	
	# Zuluhed
	create_character = {
		template = zuluhed_character_template
		name = "Zuluhed"
		location = scope:dark_portal
		save_scope_as = zuluhed
	}
	scope:zuluhed = {
		give_nickname = nick_the_whacked
		
		# Gives some land
		get_random_county_effect = { GIVER = scope:warchief }
		
		# Creates clan title
		create_title_and_vassal_change = {
			type = created
			save_scope_as = title_creation
			add_claim_on_loss = no
		}
		title:d_dragonmaw = {
			change_title_holder = {
				holder = scope:zuluhed
				change = scope:title_creation
			}
		}
		resolve_title_and_vassal_change = scope:title_creation
		
		# Gives some gold and troops
		horde_clan_start_pack_effect = yes
		clan_setup_effect = { clan = title:d_dragonmaw }
	}
	
	#Nekros
	create_character = {
		template = nekros_character_template
		name = "Nekros"
		employer = scope:zuluhed
		save_scope_as = nekros
	}
	
	#Nek'rosh
	create_character = {
		template = nekrosh_character_template
		name = "Nek'rosh"
		father = scope:nekros
		employer = scope:zuluhed
		save_scope_as = nekrosh
	}
}
get_random_county_effect = {
	save_temporary_scope_as = target
	create_title_and_vassal_change = {
		type = granted
		save_scope_as = title_granting
		add_claim_on_loss = no
	}
	$GIVER$ = {
		random_held_title = {
			limit = {
				tier = tier_county
				NOT = { this = $GIVER$.capital_county }
			}
			change_title_holder = {
				holder = scope:target
				change = scope:title_granting
			}
		}
	}
	resolve_title_and_vassal_change = scope:title_granting
}
horde_clan_start_pack_effect = {
	add_gold = 250
	spawn_orc_troops_based_on_culture_effect = yes
	spawn_orc_troops_based_on_culture_effect = yes
}
# Make clan a tribal and assign laws
clan_setup_effect = {
	change_government = tribal_government
	$clan$ = {
		add_title_law = saxon_elective_succession_law
	}
}

##################################################
# Take over the Blackrock Mountain Effects

taking_the_blackrock_mountain_accept_effect = {
	# Mark the partition as being active.
	custom_tooltip = taking_the_blackrock_mountain_accept_effect.partition_active.tt
	set_global_variable = {
		name = partition_active_blackrock
		value = title:k_blackrock
	}
	
	# Burning steppes for Shadow-Council!
	## Scope:ntd_shadow_council_holder receives south-Shadowforge.
	scope:ntd_shadow_council_holder = {
		create_title_and_vassal_change = {
			type = created
			save_scope_as = change
		}
		title:c_blackrock_spire = {
			change_title_holder = {
				holder = scope:ntd_shadow_council_holder
				change = scope:change
			}
		}
		title:d_redhelm = {
			every_in_de_jure_hierarchy = { 
				limit = {
					holder.top_liege = scope:ntd_blackrock_holder
				}
				change_title_holder = {
					holder = scope:ntd_shadow_council_holder
					change = scope:change
				}
			}
		}
		title:d_burning_steppes = {
			every_in_de_jure_hierarchy = {
				limit = {
					holder.top_liege = scope:ntd_blackrock_holder
				}
				change_title_holder = {
					holder = scope:ntd_shadow_council_holder
					change = scope:change
				}
			}
		}
		
		resolve_title_and_vassal_change = scope:change
	}
	
	## Whilst scope:ntd_nord receives k_danelaw.
	##scope:ntd_nord = {
	##	create_title_and_vassal_change = {
	##		type = created
	##		save_scope_as = change
	##	}
	##	title:k_danelaw = {
	##		change_title_holder = {
	##			holder = scope:ntd_nord
	##			change = scope:change
	##		}
	##	}
	##	resolve_title_and_vassal_change = scope:change
	##	title:k_danelaw = {
	##		add_title_law = scandinavian_elective_succession_law
	##		# And make sure it follows appropriate de jures.
	##		hidden_effect = { set_de_jure_liege_title = title:k_england.de_jure_liege }
	##	}
	##}
	
	# Give k_danelaw various de jures.
	## Firstly, any duchy that it has at least one county in which isn't scope:ntd_brit's capital duchy.
	##custom_tooltip = negotiate_the_danelaw_accept_effect.de_jure_holdings_recognised.tt
	##hidden_effect = {
	##	scope:ntd_nord = {
	##		every_sub_realm_county = {
	##			limit = {
	##				kingdom = title:k_england
	##				NOT = { duchy = scope:ntd_brit.capital_county.duchy }
	##			}
	##			duchy = { set_de_jure_liege_title = title:k_danelaw }
	##		}
	##	}
	##}
	
	## Then, any independent duchy held by a Scandi-side ruler (again exempting scope:ntd_brit's capital, just in case).
	##custom_tooltip = negotiate_the_danelaw_accept_effect.independent_holdings_recognised.tt
	##hidden_effect = {
	##	every_county_in_region = {
	##		region = world_europe_west_britannia
	##		limit = {
	##			kingdom = title:k_england
	##			exists = duchy.holder
	##			duchy.holder = { negotiate_the_danelaw_norse_side_trigger = yes }
	##			NOT = { duchy = scope:ntd_brit.capital_county.duchy }
	##		}
	##		duchy = { set_de_jure_liege_title = title:k_danelaw }
	##	}
	##}
	
	# Set up a ceasefire & some opinion gain between the two rulers.
	scope:ntd_blackrock_holder = {
		# For Shadow Council
		add_truce_both_ways = {
			character = scope:ntd_shadow_council_holder
			years = 25
			name = TRUCE_SIGNED_PARTITION
		}
		add_opinion = {
			target = scope:ntd_shadow_council_holder
			modifier = respect_opinion
			opinion = 50
		}
		reverse_add_opinion = {
			target = scope:ntd_shadow_council_holder
			modifier = respect_opinion
			opinion = 50
		}
		# For the Horde
		add_truce_both_ways = {
			character = scope:ntd_e_horde_holder
			years = 25
			name = TRUCE_SIGNED_PARTITION
		}
		add_opinion = {
			target = scope:ntd_e_horde_holder
			modifier = respect_opinion
			opinion = 50
		}
		reverse_add_opinion = {
			target = scope:ntd_e_horde_holder
			modifier = respect_opinion
			opinion = 50
		}
	}
	
	# Independent rulers on both sides are extremely unimpressed with this divvying.
	## First, grab everyone applicable.
	##title:k_england = {
	##	every_in_de_jure_hierarchy = {
	##		limit = {
	##			exists = holder
	##			holder = {
	##				is_independent_ruler = yes
	##				NOR = {
	##					this = scope:ntd_actor
	##					this = scope:ntd_recipient
	##				}
	##			}
	##		}
	##		holder = { add_to_list = riled_danelaw_independents_list }
	##	}
	##}
	
	## Then, apply opinion & hidden rivalry effects.
	##every_in_list = {
	##	list = riled_danelaw_independents_list
	##	custom = negotiate_the_danelaw_accept_effect.riled_independents_list
	##	add_opinion = {
	##		target = scope:ntd_brit
	##		modifier = weak_opinion
	##		opinion = -40
	##	}
	##	add_opinion = {
	##		target = scope:ntd_nord
	##		modifier = weak_opinion
	##		opinion = -40
	##	}
	##	# We hide the rivalry stuff, both to make it seem less unappealing, and to encourage valid-feeling drama without deliberately signalling it.
	##	hidden_effect = {
	##		if = {
	##			limit = {
	##				can_set_relation_potential_rival_trigger = { CHARACTER = scope:ntd_brit }
	##			}
	##			set_relation_potential_rival = scope:ntd_brit
	##		}
	##		if = {
	##			limit = {
	##				can_set_relation_potential_rival_trigger = { CHARACTER = scope:ntd_nord }
	##			}
	##			set_relation_potential_rival = scope:ntd_nord
	##		}
	##	}
	##}
}