master_of_shadows_effect = {
	if = {
		limit = {
			scope:owner = { has_perk = master_of_shadows }
		}
		scope:owner = {
			add_character_modifier = {
				modifier = master_of_shadows_modifier
				years = 10
			}
		}
	}
}

#Sets up the Outcome Roll values
hostile_scheme_outcome_roll_setup_effect = {
	#Discovery Roll setup
	save_scope_value_as = {
		name = discovery_chance
		value = {
			value = 100
			subtract = scope:scheme.scheme_secrecy
		}
	}
}

hostile_scheme_success_roll_effect = {
	random = {
		chance = scope:scheme.scheme_success_chance
		custom_tooltip = $TOOLTIP$
		save_scope_value_as = {
			name = scheme_successful
			value = yes
		}
	}
}

hostile_scheme_discovery_roll_effect = {
	random = {
		chance = scope:discovery_chance
		custom_tooltip = $TOOLTIP$
		save_scope_value_as = {
			name = scheme_discovered
			value = yes
		}
	}
}

hostile_scheme_rival_check_effect = {
	if = {
		limit = {
			scope:scheme.scheme_owner = {
				has_relation_rival = scope:scheme.scheme_target
			}
		}
		save_scope_value_as = {
			name = targeted_rival
			value = yes
		}
	}
}

#Roll to check whether a Stasis Trap Scheme is a success or a failure, and whether the owner is discovered
stasis_trap_outcome_roll_effect = {
	#SUCCESS ROLL
	hostile_scheme_success_roll_effect = { TOOLTIP = stasis_trap_successful_roll_tt }
	### End Success roll

	#DISCOVERY ROLL
	hostile_scheme_discovery_roll_effect = { TOOLTIP = stasis_trap_become_discovered_roll_tt }
	### End Discovery roll

	hidden_effect = {
		#FIRE CORRECT ON ACTIONS
		if = {
			limit = {
				exists = scope:scheme_successful
			}
			trigger_event = {
				on_action = stasis_trap_succeeded
			}
		}
		else = {
			trigger_event = {
				on_action = stasis_trap_failed
			}
		}
	}
}


#Used in the immediate of the Scheme Owner's success event
stasis_trap_success_effect = {
	#Check if it is a Rival being murdered
	hostile_scheme_rival_check_effect = yes
	#End of Rival check
	
	scope:target = {
		trigger_event = stasis_trap_outcome.5001
	}

	stun_character_effect = {
		TARGET = scope:target
		STUNNER = scope:owner
	}

	#Stress reduction
	if = {
		limit = {
			scope:scheme.scheme_owner = {
				has_trait = sadistic
			}
		}
		scope:scheme.scheme_owner = {
			stress_impact = {
				sadistic = minor_stress_impact_loss
			}
		}
	}
	if = {
		limit = {
			exists = scope:targeted_rival
		}
		if = {
			limit = {
				scope:scheme.scheme_owner = {
					has_trait = vengeful
				}
			}
			scope:scheme.scheme_owner = {
				stress_impact = {
					vengeful = medium_stress_impact_loss
				}
			}
		}
		else_if = {
			limit = {
				scope:scheme.scheme_owner = {
					has_trait = forgiving
				}
			}
			scope:scheme.scheme_owner = {
				stress_impact = {
					base = medium_stress_impact_loss
					forgiving = minor_stress_impact_gain
				}
			}
		}
		else = {
			scope:scheme.scheme_owner = {
				add_stress = medium_stress_loss
			}
		}
	}
	
	scope:scheme = {
		end_scheme = yes
	}
}


stasis_trap_failure_effect = {
	#Add Watchful Modifier to the target
	scope:target = {
		show_as_tooltip = {
			add_character_modifier = {
				modifier = watchful_modifier
				days = watchful_modifier_duration
			}
		}
	}

	scope:target = {
		trigger_event = stasis_trap_outcome.5002
	}
}

successful_stasis_trap_outcome_event_option_effect = {
	if = {
		limit = {
			faith = {
				has_doctrine_parameter = piety_gain_from_successful_intrigue_schemes
			}	
		}
		add_piety = minor_piety_gain
	}
}

stun_character_effect = {
	$TARGET$ = { save_temporary_scope_as = new_target }
	$STUNNER$ = { save_temporary_scope_as = stunner }

	scope:new_target = {
		add_character_modifier = {
			modifier = stasis_trap_stunned
			years = 3
		} 
		trigger_event = {
			id = stasis_trap_outcome.5003
			years = 3
		}
	}

	hidden_effect = {
		#Disband any scheme you have against them
		scope:stunner = {
			if = {
				limit = {
					any_scheme = {
						scheme_target = scope:new_target
					}
				}
				every_scheme = {
					limit = {
						scheme_target = scope:new_target
					}
					end_scheme = yes
				}
			}
		}

		#Send break up event if they are your lover
		scope:stunner = {
			if = {
				limit = {
					has_relation_lover = scope:new_target
					NOT = { has_relation_rival = scope:new_target } #To enable really strange love stories
				}
				scope:new_target = {
					trigger_event = {
						id = lover.0101
						days = { 14 30 }
					}
				}
			}
		}
	}
}

dont_excecute_scheme_effect = {
	scope:scheme = {
		add_scheme_progress = -10 # Reset scheme progress
	}

	stress_impact = {
		impatient = medium_stress_impact_gain
		stubborn = medium_stress_impact_gain
	}
}

abandon_scheme_effect = {
	scope:scheme = {
		end_scheme = yes
	}

	stress_impact = {
		stubborn = medium_stress_impact_gain
	}
}

restart_scheme_effect = {
	play_music_cue = "mx_cue_stress"
	custom_tooltip = restart_scheme_tt
	
	scope:scheme = {
		add_scheme_progress = -10 # Reset scheme progress
	}
}

hostile_scheme_opinion_effect = {
	#If you pass scheme, check scheme type
	if = {
		limit = {
			exists = $SCHEME$
		}
		$SCHEME$ = {
			if = {
				limit = { scheme_type = stasis_trap_scheme }
				save_temporary_scope_value_as = {
					name = scheme_name
					value = flag:stasis_trap_scheme
				}
			}
			else = {
				save_temporary_scope_value_as = {
					name = scheme_name
					value = flag:murder
				}
			}
		}
	}
	#Otherwise consider you pass scheme type
	else = {
		save_temporary_scope_value_as = {
			name = scheme_name
			value = flag:$SCHEME$
		}
	}
	
	$VICTIM$ = {
		if = {
			limit = { is_alive = yes }

			if = {
				limit = { scope:scheme_name = flag:stasis_trap_scheme }
				if = {
					limit = { NOT = { exists = scope:scheme_successful } }
					add_opinion = {
						target = $ATTACKER$
						modifier = attempted_stasis_trapion_opinion
					}
				}
				else = {
					add_opinion = {
						target = $ATTACKER$
						modifier = stasis_traped_me_opinion
					}
				}
			}
			#By default it's murder
			else = {
				if = {
					limit = { NOT = { exists = scope:scheme_successful } }
					add_opinion = {
						target = $ATTACKER$
						modifier = attempted_murder_me_crime
					}
					hidden_effect = {
						add_opinion = {
							target = $ATTACKER$
							modifier = murder_personal_grudge_opinion
							years = 2
						}
					}
				}
			}
		}

		every_spouse = {
			limit = { NOT = { this = $ATTACKER$ } }
			add_to_temporary_list = close_family_scheme_opinion_list
		}
		every_close_family_member = {
			limit = { NOT = { this = $ATTACKER$ } }
			add_to_temporary_list = close_family_scheme_opinion_list
		}

		if = {
			limit = {
				any_in_list = {
					list = close_family_scheme_opinion_list
					always = yes
				}
			}
			every_in_list = {
				list = close_family_scheme_opinion_list
				custom = all_close_family_and_spouses

				if = {
					limit = { scope:scheme_name = flag:stasis_trap_scheme }
					if = {
						limit = { NOT = { exists = scope:scheme_successful } }
						add_opinion = {
							target = $ATTACKER$
							modifier = attempted_stasis_trapion_close_family_opinion
						}
					}
					else = {
						add_opinion = {
							target = $ATTACKER$
							modifier = stasis_traped_close_family_opinion
						}
					}
				}
				#By default it's murder
				else = {
					if = {
						limit = { NOT = { exists = scope:scheme_successful } }
						add_opinion = {
							target = $ATTACKER$
							modifier = attempted_murder_close_family_crime
						}
					}
					else = {
						add_opinion = {
							target = $ATTACKER$
							modifier = murdered_close_family_crime
						}
					}
				}
			}
		}
	}
}