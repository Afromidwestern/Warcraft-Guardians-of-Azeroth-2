
story_cycle_criminal_loan = {
	on_setup = { 
		#should have a starting value stored in var:loan_value > 0
		#should have a current value stored in var:current_value = var:loan_value
		#should have a promised payment stored in var:last_promised_payment <= var:loan_value
		#should have a loan shark scope:loan_shark
		#should have a title scope:loan_shark_title (for passing ownership of loan)
	}
	on_end = { }
	on_owner_death = { 
		#trigger loan to transfer to next of kin prompt for scope:loan_shark
	}

	effect_group = {
		months = 1 

		# demand immediate payment 
		triggered_effect = {
			trigger = { 
				scope:story_owner = { 
					short_term_gold > var:last_promised_payment.value
				}
				NOT = { var:last_punishment = flag:recent }
				exists = scope:loan_shark
			}
			effect = { 
				#trigger immediate payment demand prompt for scope:loan_shark
				set_variable = { 
					name = last_punishment
					value = flag:recent
					days = 90
				}
			}
		}

		# terrorize them
		triggered_effect = {
			trigger = { 
				scope:story_owner = { 
					monthly_character_income <= 0
				}
				NOT = { var:last_punishment = flag:recent }
				exists = scope:loan_shark
			}
			effect = { 
				#trigger warning or attack prompt for scope:loan_shark
				set_variable = { 
					name = last_punishment
					value = flag:recent
					days = 90
				}
			}
		}

		#demand promised payment
		triggered_effect = {
			trigger = { 
				NOT = { has_variable = var:last_promised_payment }
				exists = scope:loan_shark
			}
			effect = { 
				#trigger promised payment demand prompt for scope:loan_shark
				set_variable = { 
					name = last_punishment
					value = flag:recent
					days = 90
				}
			}
		}

		#check if loan shark is dead
		triggered_effect = {
			trigger = { 
				NOT = {exists = scope:loan_shark}
			}
			effect = { 
				scope:loan_shark_title.holder = { 
					if = { 
						limit = { has_realm_bandit_authority = yes } 
						random_list = { 
							75 = { 
								modifier = {
									trigger = { has_trait = diligent has_trait = greedy has_trait = arbitrary }
									add = 25
								}
								modifier = {
									trigger = { has_trait = lazy has_trait = just has_trait = compassionate has_trait = forgiving }
									add = -50
								}
								save_scope_as = loan_shark
								# ooh, nice, looks like i inherited some debt
							}
							25 = { 
								modifier = {
									trigger = { has_trait = lazy has_trait = just has_trait = compassionate has_trait = forgiving }
									add = 50
								}
								modifier = {
									trigger = { has_trait = diligent has_trait = greedy has_trait = arbitrary }
									add = -25
								}
								scope:story_owner = {
									# they forgot about my debt! yay!
								}
							}
						}
					}
					else = { 
						scope:story_owner = {
							# they forgot about my debt! yay!
						}
					}
				}
			}
		}
	}
}
