namespace = WCHOI

#########################################
#
#	Horde Invasion events - CK3 Edition
#
#########################################

# Setup Blackhand and the associated story
WCHOI.1 = {
	type = empty
	hidden = yes
	
	trigger = {
		current_date >= 583.1.1
		dark_portal_was_opened_trigger = no
	}

	immediate = {
		add_to_global_variable_list = {
			name = wc_events_happened
			target = flag:dark_portal_was_opened
		}
		
		debug_log = "The Horde has appeared!"
		debug_log_date = yes

		title:e_horde.holder = {
			create_story = story_horde_invasion
			save_scope_as = story_owner
		}
	}
}

# Starts the Horde Invasion
WCHOI.2 = {
	type = character_event
	title = WCHOI_2_TITLE
	desc = WCHOI_2_DESC
	theme = war
	override_background = {
		reference = wc_background_dark_portal
	}
	left_portrait = {
		character = scope:blackhand
		animation = personality_bold
	}
	right_portrait = scope:stormwind_holder

	option = {
		name = {
			text = {
				first_valid = {
					triggered_desc = { # Corrupted orcs option
						trigger = { faith = faith:orcish_fel }
						desc = WCHOI_2_OPT_A
					}
					triggered_desc = { # Frostwolf option
						trigger = { faith = faith:orcish_shamanism }
						desc = WCHOI_2_OPT_B
					}
					desc = WCHOI_2_OPT_C # Outsider option
				}
			}
		}
	}
}

# Ends the Horde Invasion when enough lands taken
WCHOI.3 = { # Save the Horde?
	type = character_event
	title = WCHOI_2_TITLE
	desc = WCHOI_3_DESC
	theme = war
	override_background = {
		reference = wc_background_dark_portal
	}
	left_portrait = root

	option = { # The orcs need their warchief!
		trigger = {
			custom_description = {
				text = can_save_the_first_horde_tooltip
				OR = {
					has_game_rule = wc_collapse_of_the_first_horde_never

					NOT = {
						pol_faction_exists_trigger = { faction = alliance } # TODO - update this when we add dismantle cb for all unions

						has_game_rule = wc_collapse_of_the_first_horde_always
					}
				}
			}
		}
		show_as_unavailable = {
			NOT = { has_game_rule = wc_collapse_of_the_first_horde_always }
		}

		name = WCHOI_3_OPT_A

		if = {
			limit = {
				NOR = {
					has_game_rule = wc_collapse_of_the_first_horde_can_collapse_not
					has_game_rule = wc_collapse_of_the_first_horde_never
				}
			}

			add_prestige = monumental_prestige_gain
			dynasty = { add_dynasty_prestige = monumental_dynasty_prestige_gain }

			disband_horde_effect = { LIMIT_SIZE = medium_realm_size }
		}
		else = {
			custom_tooltip = wc_save_the_first_horde_tooltip

			add_prestige = massive_prestige_gain
			dynasty = { add_dynasty_prestige = massive_dynasty_prestige_gain }
		}

		ai_chance = {
			base = 800
			ai_value_modifier = {
				ai_greed = 1
				ai_compassion = -1
			}
			modifier = {
				factor = 2

				has_trait = ambitious
			}
		}
	}
	option = { # We'll go our own way
		trigger = {
			NOT = { has_game_rule = wc_collapse_of_the_first_horde_never }
		}
		name = WCHOI_3_OPT_B

		disband_horde_effect = { LIMIT_SIZE = minor_realm_size }

		ai_chance = {
			base = 200
			ai_value_modifier = {
				ai_greed = -1
				ai_compassion = 1
			}
		}
	}
}

WCHOI.4 = {
	type = character_event
	title = WCHOI_2_TITLE
	desc = WCHOI_3_DESC
	theme = war
	override_background = {
		reference = wc_background_dark_portal
	}
	left_portrait = scope:warchief

	option = {  # The orcs need their warchief!
		trigger = { culture_group = culture_group:orc_group }
		name = WCHOI_3_OPT_A

		add_character_modifier = {
			modifier = attempting_reunification_modifier
			years = 10
		}

		ai_chance = {
			base = 0
			ai_value_modifier = {
				ai_greed = 1
				ai_boldness = 0.5
				ai_energy = 0.25
			}
			modifier = {
				add = 100

				has_trait = ambitious
			}
			modifier = {
				factor = 3

				highest_held_title_tier > tier_county
			}
			modifier = {
				factor = 3

				highest_held_title_tier > tier_duchy
			}
		}
	}
	option = { # We'll go our own way
		trigger = { culture_group = culture_group:orc_group }

		add_prestige = massive_prestige_gain
		dynasty = { add_dynasty_prestige = massive_dynasty_prestige_gain }

		name = WCHOI_3_OPT_B

		ai_chance = {
			base = 100
		}
	}
	option = {
		trigger = {
			NOT = {
				culture_group = culture_group:orc_group
			}
		}
		name = ITS_OVER
	}
}

#Spawns Horde Troops for the Horde
WCHOI.5 = {
	type = character_event
	hidden = yes
	
	immediate = {
		spawn_horde_troops_effect = yes
		spawn_horde_troops_effect = yes
		spawn_horde_troops_effect = yes
		# spawn_horde_troops_effect = yes
		every_vassal = {
			limit = { culture_group = culture_group:orc_group }
			spawn_horde_troops_effect = yes
		}
	}
}
#Spawns Horde Troops for new Warchief
WCHOI.6 = {
	type = character_event
	hidden = yes
	
	immediate = {
		spawn_horde_troops_effect = yes
		spawn_horde_troops_effect = yes
	}
}

###Invites the Burning Blade and Dragonmaw clans
#Delayer event
WCHOI.9 = {
	type = character_event
	hidden = yes
	
	immediate = {
		invite_burning_blade_effect = yes
		invite_dragonmaw_effect = yes
		
		trigger_event = WCHOI.10
	}
}
#Delayed event
WCHOI.10 = {
	type = character_event
	title = WCHOI_2_TITLE
	desc = EVTDESC_WCFTW_4
	theme = war
	override_background = {
		reference = wc_background_dark_portal
	}
	left_portrait = scope:zuluhed
	right_portrait = scope:dharl
	
	option = {
		name = LOKTAR_OGAR
		
		spawn_horde_troops_effect = yes
		spawn_horde_troops_effect = yes
		# spawn_horde_troops_effect = yes
	}
}