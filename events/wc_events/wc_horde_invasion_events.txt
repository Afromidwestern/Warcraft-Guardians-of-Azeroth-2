namespace = wc_horde_invasion

##################################################
# Sacking of Northshire
# by Dione and ElMariuso
##################################################

# Conquering of Northshire
WCWAR.20 = {
	title = WCWAR.20.t
	desc = WCWAR.20.d
	type = character_event
	theme = war

	left_portrait = {
		character = root
		animation = personality_honorable
	}

	immediate = {
		title:e_horde.holder = { save_scope_as = horde_leader }
	}

	# Sack the city
	option = {
		name = WCWAR.20.a
		add_short_term_gold = massive_gold_value
		title:c_northshire = {
			change_development_level = {
				value = {
					add = development_level
					multiply = { -0.8 -0.9 }
				}
			}
			every_county_province = {
				save_scope_as = current_province
				custom_tooltip = destroy_all_buildings_tt
				hidden_effect = {
					title:b_belsloe = { 
						if = {
							limit = {
								is_holy_order = yes
							}
						}
						revoke_lease = yes
					} 
					title:b_northshire = { 
						if = {
							limit = {
								is_holy_order = yes
							}
						}
						revoke_lease = yes
					} 
					title:b_rosgal = { 
						if = {
							limit = {
								is_holy_order = yes
							}
						}
						revoke_lease = yes
					} 
					set_holding_type = tribal_holding #destroys all buildings besides special ones
					if = {
						limit = {
							has_building = northshire_abbey_01
						}
						remove_building = northshire_abbey_01
					}	
				}
			}
		}
		# artifacts? - not sure which ones yet
		spawn_army = { # 1000 
			uses_supply = no
			inheritable = no
			name = remnants_northshire
			levies = 200
			location = title:b_northshire.title_province
			origin = title:b_northshire.title_province
			men_at_arms = { # 300
				type = armored_horsemen
				stacks = 6
			}
			men_at_arms = { # 500
				type = armored_footmen
				stacks = 5
			}
		}
		
		set_global_variable = {
			name = brotherhood_northshire_destroyed
			value = yes 
		}

		custom_tooltip = previoush_tt
		hidden_effect = {
			scope:previous_holder = {
				override_death_killer_effect = {
					death_reason = death_battle
					killer = scope:horde_leader
				}
			}
		}

		ai_chance = {
			base = 100
			modifier = {
				add = 50
				OR = {
					has_trait = wrathful
					has_trait = vengeful
					has_trait = greedy
					has_trait = callous
				}
			}
		}

		every_vassal_or_below = {
			trigger_event = {
				id = WCWAR.25
				days = 2
			}
		}

		# Notification for humans
		every_ruler = {
			limit = {
				has_trait = creature_human
			}
			trigger_event = {
				id = wc_religious.001
				days = 5
			}
		}
	}

	# Keep it how it is
	option = {
		name = WCWAR.20.b
		ai_chance = {
			base = 10
			modifier = {
				add = 100
				has_trait = compassionate
			}
		}
	}
}

# Notification for Horde Vassals
WCWAR.25 = {
	title = WCWAR.20.t
	desc = {
		desc = WCWAR.25.d
		first_valid = {
			triggered_desc = {
				trigger = {
					has_title = title:d_twilights_hammer_clan
				}
				desc = WCWAR.25.d_twilight
			}
		}
	}

	type = character_event
	theme = war

	immediate = {
		title:c_northshire = { save_scope_as = northshire }
		title:e_horde.holder = { save_scope_as = horde_leader }
	}

	left_portrait = {
		character = scope:horde_leader
		animation = personality_honorable
	}

	right_portrait = {
		character = root
		animation = thinking
	}

	# ok
	option = {
		name = WCWAR.25.a
		add_short_term_gold = 10
	}

	# Ask for lands
	option = {
		name = WCWAR.25.b

		trigger = {
			has_title = title:d_twilights_hammer_clan
		}

		custom_tooltip = ask_for_lands_tt

		scope:horde_leader = {
			title:d_twilights_hammer_clan.holder = {
				save_scope_as = twilight_holder
			}
			trigger_event = {
				id = WCWAR.30
				days = 1
			}
		}

		ai_chance = {
			base = 100
			modifier = {
				add = 1000
				has_title = title:d_twilights_hammer_clan
			}
		}
	}
}

# Asking for lands (notification for horde leader)
WCWAR.30 = {
	title = WCWAR.30.t
	desc = WCWAR.30.d

	type = character_event
	theme = war

	left_portrait = {
		character = root
		animation = thinking
	}

	right_portrait = {
		character = scope:twilight_holder
		animation = beg
	}

	# yes
	option = {
		name = WCWAR.30.a
		ai_chance = {
			base = 100
			modifier = {
				add = 50
				OR = {
					has_trait = zealous
					has_trait = compassionate
				}
			}
		}
	}

	# n o
	option = {
		name = WCWAR.30.b
		add_character_flag = {
			flag = no_northshire
			days = 30
		}

		ai_chance = {
			base = 10
			modifier = {
				add = 100
				OR = {
					has_trait = callous
					has_trait = greedy
				}
			}
		}
	}

	after = {
		scope:horde_leader = {
			every_vassal_or_below = {
				trigger_event = {
					id = WCWAR.35
					days = 5
				}
			}
		}
	}
}

# Asking for lands notification + response
WCWAR.35 = {
	title = WCWAR.30.t
	type = character_event
	theme = war
	left_portrait = {
		character = root
		animation = personality_honorable
	}
	desc = {
		first_valid = {
			triggered_desc = {
				trigger = { 
					NOT = { this = scope:twilight_holder }
					NOT = { scope:horde_leader = { has_character_flag = no_northshire } }
				}
				desc = WCWAR.35.d
			}
			triggered_desc = {
				trigger = { 
					this = scope:twilight_holder
					scope:horde_leader = { has_character_flag = no_northshire }
				}
				desc = WCWAR.35.d_fail
			}
			triggered_desc = {
				trigger = { 
					this = scope:twilight_holder
					NOT = { scope:horde_leader = { has_character_flag = no_northshire } }
				}
				desc = WCWAR.35.d_success
			}
		}
	}

	immediate = {
		title:c_northshire = { save_scope_as = northshire }
		title:e_horde.holder = { save_scope_as = horde_leader }
		title:d_twilights_hammer_clan.holder = { save_scope_as = twilight_holder }
	}

	trigger = {
		#only notify vassals if twilight's hammer leader gets the land
		OR = {
			this = scope:twilight_holder
			NOT = { scope:horde_leader = { has_character_flag = no_northshire } }
		}
	}

	# ok
	option = {
		name = WCWAR.35.a
		trigger = {
			NOT = { this = scope:twilight_holder }
		}
	}

	# good
	option = {
		name = WCWAR.35.b
		trigger = {
			this = scope:twilight_holder
			NOT = { scope:horde_leader = { has_character_flag = no_northshire } }
		}
	}

	# bad 
	option = {
		name = WCWAR.35.b
		trigger = {
			this = scope:twilight_holder
			scope:horde_leader = { has_character_flag = no_northshire } 
		}

		stress_impact = {
			base = medium_stress_impact_gain
		}
	}

	after = {
		if = {
			limit = { NOT = { scope:horde_leader = { has_character_flag = no_northshire } } }
			scope:twilight_holder = {
				create_title_and_vassal_change = {
					type = granted
					save_scope_as = change
					add_claim_on_loss = no
				}
				scope:northshire = {
					change_title_holder = {
						holder = scope:twilight_holder
						change = scope:change
					}
				}

				resolve_title_and_vassal_change = scope:change
				set_realm_capital = title:c_northshire
			}			
		}
	}
}

##################################################
# Consequences of Northshire
# by Dione and ElMariuso
##################################################