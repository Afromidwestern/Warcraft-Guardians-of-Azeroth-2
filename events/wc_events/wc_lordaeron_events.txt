namespace = forsaken 

##############################################
# 0001 - 0099: Pre-Divergence Events
##############################################

# interactions between Arthas anc a character who will come to rule the Forsaken (Sylvanas or someone else)

##############################################
# 0501 - 0599: Divergence Events
##############################################

# events where that character breaks away from the scourge

##############################################
# 1001 - 1099: Reclamation of Lordaeron Events
##############################################

forsaken.1001 = { 

	type = character_event
	title = forsaken.1001.title
	theme = stewardship
	override_background = market

	desc = { 
		first_valid = { 
			triggered_desc = { 
				trigger = { 
					NOT = { title:b_lordaeron.holder = { any_liege_or_above = { this = scope:story.story_owner } } }
				}
				desc = forsaken.1001.desc.independent
			}
			desc = forsaken.1001.desc.owned
		}
	}

	immediate = { 
		#scope:story.story_owner = { save_scope_as = story_owner }
		title:b_lordaeron.title_province = { 
			remove_building = ruined_palace_01
			add_special_building = ruined_palace_02 
		}
		title:b_lordaeron = {
			remove_variable = develop_the_undercity
			set_variable = { name = develop_the_undercity value = flag:finished }
			hidden_effect = { if = { limit = { var:develop_the_undercity = flag:finished } } } #error.log
		}
		title:c_lordaeron = {
			set_county_culture = culture:forsaken
		}
	}

	right_portrait = { 
		character = root
		animation = steward
	}

	trigger = {
		title:b_lordaeron = {
			holder = { 
				self_or_liege_is_of_forsaken_like_culture = yes
			} 
			var:develop_the_undercity ?= flag:ready
		}
	}

	#TODO: use a story cycle to handle complex fails such as sylvanas_character deaths
	on_trigger_fail = { 
		title:b_lordaeron.holder = { 
			if = { 
				limit = { NOT = { this = root } self_or_liege_is_of_forsaken_like_culture = yes } 
				trigger_event = { id = forsaken.1001 days = 1 }
			}
			else = { 
				trigger_event = { id = forsaken.1002 days = 1 }
			}
		}
	}

	option = { 
		name = { 
			text = {
				first_valid = {
					triggered_desc = {
						trigger = { NOT = { title:b_lordaeron.holder = { any_liege_or_above = { this = scope:story.story_owner } } } }
						desc = forsaken.1001.opt.a.independent
					}
					desc = forsaken.1001.opt.a.owned
				}
			}
		} 

		show_as_tooltip = { 
			custom_tooltip = forsaken.1001.tooltip.a
		}

		hidden_effect = { 
			global_var:sylvanas_character = { 
				if = {
					limit = { is_alive = yes }
					trigger_event = { 
						id = forsaken.1100 
						years = 2
						delayed = yes
					}
				}
			}

			create_dispersed_crypto_religionists = { FAITH = faith:forgotten_shadow }
			#TODO: Link the random vassals to the next event? could be cool to have secret faith characters randomly dispersed tho
		}
	}

}

# Failed construction of Undercity
forsaken.1002 = { 

	type = character_event
	title = forsaken.1002.title
	desc = forsaken.1002.desc
	theme = dungeon
	override_background = market

	right_portrait = { 
		character = root
		animation = stress
	}

	immediate = { 
		title:b_lordaeron = {
			title_province = {
				remove_province_modifier = wc_building_undercity
			}
			set_variable = { 
				name = develop_the_undercity
				value = flag:interruption
				years = 5
			}
			hidden_effect = { if = { limit = { var:develop_the_undercity = flag:interruption } } }
		}
		
	}

	option = { 
		name = forsaken.1002.opt.a
		show_as_tooltip = { 
			custom_tooltip = forsaken.1002.tooltip.a
		}
	}
	
}

#Change in story ownership
forsaken.1003 = { 

	type = character_event
	title = forsaken.1003.title
	desc = forsaken.1003.desc
	theme = skull

	right_portrait = { 
		character = root
		animation = grief
	}

	option = { 
		name = forsaken.1003.opt.a
	}
	
}

#Owner of Lordaeron who is not story_owner upon completion
forsaken.1004 = { 

	type = character_event
	title = forsaken.1004.title
	theme = stewardship

	desc = { 
		first_valid = { 
			triggered_desc = { 
				trigger = { NOT = { title:b_lordaeron.holder = { any_liege_or_above = { this = scope:story.story_owner } } } }
				desc = forsaken.1004.desc.independent
			}
			desc = forsaken.1004.desc.vassal
		}
	}

	left_portrait = { 
		character = root
		animation = celebrate_sword
	}

	right_portrait = { 
		character = scope:story.story_owner
		scripted_animation = {
			triggered_animation = {
				trigger = { NOT = { title:b_lordaeron.holder = { any_liege_or_above = { this = scope:story.story_owner } } } }
				animation = disapproval
			}
			animation = steward
		}
	}

	option = { 
		trigger = { NOT = { title:b_lordaeron.holder = { any_liege_or_above = { this = scope:story.story_owner } } } }
		name = forsaken.1004.opt.a
		add_prestige = 100
		add_gold = 25
		show_as_tooltip = { 
			custom_tooltip = forsaken.1004.tooltip.a
		}
		hidden_effect = { 
			title:b_lordaeron.holder = { 
				create_dispersed_crypto_religionists = { FAITH = faith:forgotten_shadow }
			}
		}
	}

	option = { 
		trigger = { title:b_lordaeron.holder = { any_liege_or_above = { this = scope:story.story_owner } } }
		name = forsaken.1004.opt.b
	}
}


#####################################
#1100 - 1199: Post-Reclamation events
#####################################

#1100 - 1109: Selenite Revival

forsaken.1100 = { 

	type = character_event
	title = forsaken.1100.title
	desc = forsaken.1100.desc
	theme = faith
	override_background = wc_undercity_throne_room

	immediate = {
		every_vassal_or_below = {
			limit = {
				faith.religion = { is_in_family = rf_shadow }
				highest_held_title_tier >= tier_county
				is_ai = yes
				NOR = { 
					faith = faith:forgotten_shadow 
					government_has_flag = government_is_theocracy 
					piety_level >= 2 
					any_held_title = { this = title:b_lordaeron }
				}
				NOR = { has_trait = zealous has_trait = loyal has_trait = holy_warrior has_trait = stubborn }
			}
			add_to_temporary_list = tmp_selinites
		}
		random_in_list = {
			list = tmp_selinites
			set_character_faith = faith:forgotten_shadow
			random_held_title = {
				limit = { tier = tier_county }
				set_county_faith = faith:forgotten_shadow
			}
			save_scope_as = selinite_1 
			scope:selinite_1 = { remove_from_list = tmp_selinites }
		}
		random_in_list = {
			list = tmp_selinites
			set_character_faith = faith:forgotten_shadow
			random_held_title = {
				limit = { tier = tier_county }
				set_county_faith = faith:forgotten_shadow
			}
			save_scope_as = selinite_2
			scope:selinite_2 = { remove_from_list = tmp_selinites }
		}
		random_in_list = {
			list = tmp_selinites
			set_character_faith = faith:forgotten_shadow
			random_held_title = {
				limit = { tier = tier_county }
				set_county_faith = faith:forgotten_shadow
			}
			save_scope_as = selinite_3 
			scope:selinite_3 = { remove_from_list = tmp_selinites }
		}
	}

	right_portrait = { 
		character = root
		animation = worry
	}

	lower_left_portrait = {
		character = scope:selinite_1
	}

	lower_center_portrait = { 
		character = scope:selinite_2
	}

	lower_right_portrait = { 
		character = scope:selinite_3
	}

	trigger = {
		self_or_liege_is_of_forsaken_like_culture = yes
	}

	option = { 
		# retain sylvanas cult of personality - AI chance 75
		name = forsaken.1100.opt.a

		if = { 
			limit = { NOT = { faith = faith:forsaken_cult } }
			set_character_faith = faith:forsaken_cult
		}

		title:c_lordaeron = { 
			if = {
				limit = { holder = root }
				set_county_faith = faith:forsaken_cult
			}
		}
		add_character_modifier = { 
			modifier = wc_forsaken_subsumed_selinite_modifier
		}
		custom_tooltip = { 
			text = damned_will_convert_to_forsaken_cult
			trigger_event = { 
				id = forsaken.1101
			}
		}

		set_variable = { 
			name = selinite_decision
			value = flag:subsumed
		}
		
		ai_chance = { 
			base = 75
			ai_value_modifier = {
				ai_honor = -0.5
				ai_compassion = -1
				ai_boldness = 1
				ai_rationality = 1
			}
		}
	}

	option = { 
		# convert and delegate religious authority to cult of forgotten shadow - AI chance 20
		name = forsaken.1100.opt.b

		trigger = { NOT = { any_held_title = { is_head_of_faith = yes } } }

		if = { 
			limit = { NOT = { faith = faith:forgotten_shadow } }
			set_character_faith = faith:forgotten_shadow
		}

		title:c_lordaeron = { 
			set_county_faith = faith:forgotten_shadow
		} 

		custom_tooltip = { 
			text = cultists_will_convert_to_forgotten_shadow
			trigger_event = forsaken.1102
		}

		set_variable = { 
			name = selinite_decision
			value = flag:embraced
		}

		add_character_modifier = wc_forsaken_embraced_selinite_modifier

		ai_chance = { 
			base = 20
			ai_value_modifier = {
				ai_honor = -0.5
				ai_boldness = 1
				ai_zeal = -1
			}
		}
	}

	option = { 
		# retain cult of personality but grant religious freedom to selinites - AI chance 5
		name = forsaken.1100.opt.c
		#vassal_contract_set_obligation_level = { type = religious_rights level = 1 } wanted to do this but necro govt blocks it
		
		chance_convert_county_to_selinite = yes

		set_variable = { 
			name = selinite_decision
			value = flag:tolerated
		}
		
		add_character_modifier = wc_forsaken_tolerated_selinite_modifier

		ai_chance = { 
			base = 5
			ai_value_modifier = {
				ai_honor = 0.5
				ai_compassion = 1
				ai_boldness = -1
				ai_zeal = -1
			}
		}
	}
}

forsaken.1101 = { 
	hidden = yes 
	type = character_event

	immediate = { 

		save_scope_as = actor

		primary_title = {
			every_in_de_facto_hierarchy = {
				limit = { 
					tier = tier_county  
					faith = faith:death_god 
				}
				set_county_faith = faith:forsaken_cult 
			}
		}

		every_courtier_or_guest = {
			limit = { 
				OR = {
					culture = culture:scourge
					faith = faith:death_god
				}
			}
			save_temporary_scope_as = recipient
			new_faith_created_conversion_effect = yes
		}

		every_vassal_or_below = { 
			limit = { 
				OR = {
					culture = culture:scourge 
					faith = faith:death_god
				}
			}

			save_temporary_scope_as = recipient
			new_faith_created_conversion_effect = yes

			every_courtier_or_guest = {
				limit = { 
					OR = {
						culture = culture:scourge
						faith = faith:death_god
					}
				}
				save_temporary_scope_as = recipient
				new_faith_created_conversion_effect = yes
			}
		}
	}
}

forsaken.1102 = { 
	hidden = yes 
	type = character_event

	immediate = { 
		save_temporary_scope_as = recipient 
		save_scope_as = actor 

		new_faith_created_conversion_effect = yes

		every_courtier_or_guest = {
			limit = { 
				OR = {
					culture = culture:forsaken 
					faith = faith:forsaken_cult
					faith = faith:death_god
				}
			}
			save_temporary_scope_as = recipient
			new_faith_created_conversion_effect = yes
		}

		every_vassal_or_below = { 
			limit = { 
				OR = {
					culture = culture:forsaken 
					faith = faith:forsaken_cult
					faith = faith:death_god
				}
			}
			save_temporary_scope_as = recipient
			new_faith_created_conversion_effect = yes

			every_courtier_or_guest = {
				limit = { 
					OR = {
						culture = culture:forsaken 
						faith = faith:forsaken_cult
						faith = faith:death_god
					}
				}
				save_temporary_scope_as = recipient
				new_faith_created_conversion_effect = yes
			}
		}
	}
}

forsaken.1103 = { 
	type = character_event
	title = forsaken.1103.title
	theme = faith
	override_background = wc_undercity_throne_room

	desc = { 
		first_valid = { 
			triggered_desc = { 
				trigger = { scope:story.story_owner = { var:selinite_decision = flag:subsumed } }
				desc = forsaken.1103.desc.subsumed
			} 
			triggered_desc = { 
				trigger = { scope:story.story_owner = { var:selinite_decision = flag:embraced } }
				desc = forsaken.1103.desc.embraced
			}
			desc = forsaken.1103.desc.tolerated
		}
	}

	trigger = { 
		is_of_forsaken_like_culture = yes
		NOT = { faith = faith:forgotten_shadow }
	}

	option = { 
		name = forsaken.1103.opt.a 

		if = { 
			limit = { NOT = { faith = faith:forsaken_cult } }
			set_character_faith = faith:forsaken_cult
		}

		title:c_lordaeron = { 
			set_county_faith = faith:forsaken_cult
		}

		custom_tooltip = { 
			text = damned_will_convert_to_forsaken_cult
			trigger_event = { 
				id = forsaken.1101
			}
		}

		if = { 
			limit = { 
				scope:story.story_owner = { var:selinite_decision = flag:subsumed } 
			 	any_liege_or_above = { this = scope:story.story_owner } 
			} 
			progress_towards_friend_effect = {
				CHARACTER = scope:story.story_owner
				OPINION = 50
				REASON = forsaken.1103.obeyed
			}
		} 
		else_if = { 
			limit = { scope:story.story_owner = { var:selinite_decision = flag:embraced } }
			if = { 
				limit = { any_liege_or_above = { this = scope:story.story_owner } } 
				progress_towards_rival_effect = {
					CHARACTER = scope:story.story_owner
					OPINION = 50
					REASON = forsaken.1103.disobeyed
				}
				add_piety = 100
			} else = { 
				add_character_modifier = wc_forsaken_subsumed_selinite_modifier
			} 
		} 
		else_if = { 
			limit = { 
				scope:story.story_owner = { var:selinite_decision = flag:tolerated } 
			} 
			if = { 
				limit = { any_liege_or_above = { this = scope:story.story_owner } }
				progress_towards_rival_effect = {
					CHARACTER = scope:story.story_owner
					OPINION = 20
					REASON = forsaken.1103.disobeyed
				}
				add_piety = 100
			} else = { 
				add_character_modifier =  wc_forsaken_subsumed_selinite_modifier
			} 
		}
	}

	option = { 
		name = forsaken.1103.opt.b 

		title:c_lordaeron = { 
			set_county_faith = faith:forgotten_shadow
		}

		if = { 
			limit = { NOT = { faith = faith:forgotten_shadow } }
			set_character_faith = faith:forgotten_shadow
		}

		custom_tooltip = { 
			text = cultists_will_convert_to_forgotten_shadow
			trigger_event = forsaken.1102
		}
		if = { 
			limit = { 
				scope:story.story_owner = { var:selinite_decision = flag:embraced }
				any_liege_or_above = { this = scope:story.story_owner } 
			} 
			progress_towards_friend_effect = {
				CHARACTER = scope:story.story_owner
				OPINION = 50
				REASON = forsaken.1103.obeyed
			}
			
		} 
		else_if = { 
			limit = { scope:story.story_owner = { var:selinite_decision = flag:subsumed } }
			if = { 
				limit = { any_liege_or_above = { this = scope:story.story_owner } } 
				progress_towards_rival_effect = {
					CHARACTER = scope:story.story_owner
					OPINION = 50
					REASON = forsaken.1103.disobeyed
				}
				add_piety = 100
			} else = { 
				add_character_modifier = wc_forsaken_embraced_selinite_modifier
			}
		} 
		else_if = { 
			limit = { 
				scope:story.story_owner = { var:selinite_decision = flag:tolerated } 
				NOT = { any_liege_or_above = { this = scope:story.story_owner } }
			}
			add_character_modifier = wc_forsaken_embraced_selinite_modifier
		}
	}

	option = { 
		name = forsaken.1103.opt.c
		
		if = { 
			limit = { 
				scope:story.story_owner = { var:selinite_decision = flag:tolerated } 
				any_liege_or_above = { this = scope:story.story_owner } 
			}
			progress_towards_friend_effect = {
				CHARACTER = scope:story.story_owner
				OPINION = 50
				REASON = forsaken.1103.obeyed
			}
		} 
		else_if = { 
			limit = { scope:story.story_owner = { var:selinite_decision = flag:subsumed } } 
			if = { 
				limit = { any_liege_or_above = { this = scope:story.story_owner } } 
				progress_towards_rival_effect = {
					CHARACTER = scope:story.story_owner
					OPINION = 20
					REASON = forsaken.1103.disobeyed
				}
				add_character_modifier =  wc_forsaken_tolerated_selinite_modifier
			}
		} 
		else_if = { 
			limit = { 
				scope:story.story_owner = { var:selinite_decision = flag:embraced } 
				NOT = { any_liege_or_above = { this = scope:story.story_owner } }
			} 
			add_character_modifier =  wc_forsaken_tolerated_selinite_modifier
		}

		chance_convert_county_to_selinite = yes
	}

}


######################################
#9000 - 9099: Random occurrence events
######################################

# religious minority caught stealing arcane works
forsaken.9001 = { 

	type = character_event
	title = lordaeron.9001.title
	theme = intrigue

	desc = { 
		first_valid = { 
			triggered_desc = { 
				trigger = { scope:new_character.faith = faith:echo_of_life }
				desc = lordaeron.9001.desc.echoseeker
			}
			triggered_desc = { 
				trigger = { scope:new_character.faith = faith:alchemical_materialism }
				desc = lordaeron.9001.desc.alchemist
			}
			triggered_desc = { 
				trigger = { scope:new_character.faith = faith:forsaken_cult }
				desc = lordaeron.9001.desc.forsaken
			}
			desc = lordaeron.9001.desc.forgotten
		}
	}

	immediate = { 
		
		create_character = {
			age = { 18 40 }
			diplomacy = { min_template_low_skill max_template_decent_skill }
			martial = { min_template_low_skill max_template_low_skill }
			stewardship = { min_template_low_skill max_template_average_skill }
			intrigue = { min_template_decent_skill max_template_decent_skill }
			learning = { min_template_decent_skill max_template_decent_skill }
			faith = faith:holy_light
			culture = root.culture
			location = root.location
			random_traits_list = {
				count = 1
				education_intrigue_2 = {}
				education_learning_2 = {}
			}
			random_traits = yes
			gender_female_chance = 50
			save_scope_as = new_character
			after_creation = { 
				trigger_race_giving_no_gene_effect = yes
				become_undead_effect = yes
				random_list = { 
					50 = {
						modifier = { 
							factor = 0
							root.faith = faith:echo_of_life
						}
						set_character_faith = faith:echo_of_life 
					}
					50 = { 
						modifier = { 
							factor = 0
							OR = { 
								root.faith = faith:alchemical_materialism 
								NOT = { 
									title:b_lordaeron = { 
										var:develop_the_undercity ?= flag:finished
									}
								}
							}
						}
						set_character_faith = faith:alchemical_materialism 
					}
					50 = {
						trigger = { 
							OR = { 
								root.faith = faith:echo_of_life
								root.faith = faith:alchemical_materialism
							}
							title:b_lordaeron = { 
								var:develop_the_undercity ?= flag:finished
							}
						}
						set_character_faith = faith:forgotten_shadow 
						add_trait = devoted
					}
					50 = {
						trigger = { 
							OR = { 
								root.faith = faith:echo_of_life
								root.faith = faith:alchemical_materialism
							}
							NOT = { 
								title:b_lordaeron = { 
									var:develop_the_undercity ?= flag:finished
								}
							}
						}
						set_character_faith = faith:forsaken_cult
					}
				}
			}
		} 
		hidden_effect = {
			add_visiting_courtier = scope:new_character
			add_opinion = { 
				target = scope:new_character
				modifier = theft_opinion
			}
		}
	}

	right_portrait = { 
		character = scope:new_character
		animation = shame
	}

	left_portrait = { 
		character = root
		animation = disapproval
	}

	#execute them
	option = { 
		name = lordaeron.9000.opt.e
		show_as_tooltip = {
			execute_prisoner_effect = {
				VICTIM = scope:new_character
				EXECUTIONER = root
			}
		}
		add_dread = 5
		add_character_modifier = { 
			modifier = wc_executed_religious_minority_modifier
			years = 2
		}
	}

	#imprison them
	option = { 
		name = lordaeron.9000.opt.a
		imprison_character_effect = {
			TARGET = scope:new_character
			IMPRISONER = root
		}
	}

	#fine them
	option = { 
		name = lordaeron.9000.opt.b
		trigger = { 
			NOT = { scope:new_character.faith = faith:forsaken_cult}
			stewardship >= decent_skill_rating 
		}
		add_gold = 50
		add_hook = {
			type = indebted_hook
			target = scope:new_character
		} 
		remove_courtier_or_guest = { 
			character = scope:new_character
			new_location = title:b_dalaran.title_province
		}
	}

	#invite them to court and get hook
	option = { 
		name = lordaeron.9000.opt.c
		trigger = { NOT = { scope:new_character.faith = faith:forsaken_cult}}
		scope:new_character = { 
			progress_towards_friend_effect = {
				REASON = friend_showed_mercy
				CHARACTER = root
				OPINION = 50
			}
		}
		add_hook = {
			target = scope:new_character
			type = loyalty_hook
		}
	}

	#give them passage to Dalaran and get hook
	option = { 
		name = lordaeron.9000.opt.d
		trigger = { learning >= decent_skill_rating }
		add_hook = {
			target = scope:new_character
			type = loyalty_hook
		}
		show_as_tooltip = { 
			random_list = { 
				25 = { 
					remove_courtier_or_guest = { 
						character = scope:new_character
						new_location = title:b_dalaran.title_province
					}
				}
				25 = { 
					remove_courtier_or_guest = { 
						character = scope:new_character
						new_location = title:b_caer_darrow.title_province
					}
				}
				25 = { 
					remove_courtier_or_guest = { 
						character = scope:new_character
						new_location = title:b_karazhan.title_province
					}
				}
				25 = { 
					remove_courtier_or_guest = { 
						character = scope:new_character
						new_location = title:b_gnomeregan.title_province
					}
				}
				25 = { 
					remove_courtier_or_guest = { 
						character = scope:new_character
						new_location = title:b_falthrien.title_province
					}
				}
				25 = { 
					trigger = { in_diplomatic_range = title:b_narthalas_ruins.holder}
					remove_courtier_or_guest = { 
						character = scope:new_character
						new_location = title:b_narthalas_ruins.title_province
					}
				}
				
			}
		}
	}
}
